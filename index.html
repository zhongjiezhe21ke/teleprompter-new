<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提词器 - 基础版</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        h1 {
            color: #5D5CDE;
        }
        .role-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin: 40px auto;
        }
        button {
            padding: 15px;
            font-size: 18px;
            background: #5D5CDE;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #4a49b8;
        }
        .controller-ui, .display-ui {
            display: none;
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: left;
        }
        .status {
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            background: #FEF3C7;
            color: #92400E;
            margin-bottom: 20px;
        }
        .status.connected {
            background: #D1FAE5;
            color: #065F46;
        }
        .connection-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .id-container {
            display: flex;
            margin-bottom: 10px;
        }
        input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .secondary-button {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .teleprompter-display {
            width: 100%;
            height: 300px;
            background: black;
            color: white;
            overflow: auto;
            margin-top: 20px;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 8px;
        }
        .prompter-text {
            font-size: 32px;
            text-align: center;
            padding-top: 120px;
        }
    </style>
</head>
<body>
    <h1>提词器 - 基础版</h1>
    <p>在MacBook上控制，在iPad上显示</p>
    
    <!-- 角色选择 -->
    <div id="roleSelection">
        <div class="role-buttons">
            <button id="controllerBtn" onclick="setupController()">控制端 (MacBook)</button>
            <button id="displayBtn" onclick="setupDisplay()">显示端 (iPad)</button>
        </div>
    </div>
    
    <!-- 控制端界面 -->
    <div id="controllerUI" class="controller-ui">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>控制界面</h2>
            <div id="connectionStatus" class="status">
                <span>等待连接...</span>
            </div>
        </div>
        
        <div class="connection-box">
            <h3>连接设置</h3>
            <p>你的连接ID：</p>
            <div class="id-container">
                <input id="myId" type="text" readonly>
                <button id="copyIdBtn" class="button secondary-button" onclick="copyMyId()">复制</button>
            </div>
            
            <p style="margin-top:15px">连接到显示端：</p>
            <div class="id-container">
                <input id="peerId" type="text" placeholder="输入显示端ID">
                <button id="connectBtn" class="button" onclick="connectToPeer()">连接</button>
            </div>
        </div>
        
        <div>
            <label for="promptText">提词内容</label>
            <textarea id="promptText" placeholder="在此输入需要显示的文本内容..."></textarea>
            <button id="sendBtn" class="button" onclick="sendText()">发送到提词器</button>
            <button id="clearBtn" class="button secondary-button" onclick="clearText()">清空</button>
        </div>
    </div>
    
    <!-- 显示端界面 -->
    <div id="displayUI" class="display-ui">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>显示界面</h2>
            <div id="displayConnectionStatus" class="status">
                <span>等待连接...</span>
            </div>
        </div>
        
        <div class="connection-box">
            <h3>连接设置</h3>
            <p>你的显示端ID (分享给控制端)：</p>
            <div class="id-container">
                <input id="displayId" type="text" readonly>
                <button id="copyDisplayIdBtn" class="button secondary-button" onclick="copyDisplayId()">复制</button>
            </div>
        </div>
        
        <div class="teleprompter-display">
            <div id="promptContent" class="prompter-text">
                等待接收文本...
            </div>
        </div>
    </div>
    
    <script>
        // 变量定义
        let peer = null;
        let connection = null;
        let role = null;
        
        // 角色设置
        function setupController() {
            console.log("设置控制端");
            role = 'controller';
            document.getElementById('roleSelection').style.display = 'none';
            document.getElementById('controllerUI').style.display = 'block';
            initializePeer(true);
        }
        
        function setupDisplay() {
            console.log("设置显示端");
            role = 'display';
            document.getElementById('roleSelection').style.display = 'none';
            document.getElementById('displayUI').style.display = 'block';
            initializePeer(false);
        }
        
        // PeerJS初始化
        function initializePeer(isController) {
            try {
                console.log("初始化PeerJS...");
                
                // 生成随机ID
                const randomId = (isController ? 'c-' : 'd-') + Math.random().toString(36).substring(2, 10);
                
                // 配置STUN服务器
                const peerConfig = {
                    debug: 0,
                    config: {
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                };
                
                peer = new Peer(randomId, peerConfig);
                
                peer.on('open', (id) => {
                    console.log("PeerJS连接已打开，ID:", id);
                    if (isController) {
                        document.getElementById('myId').value = id;
                    } else {
                        document.getElementById('displayId').value = id;
                    }
                });
                
                peer.on('connection', (conn) => {
                    console.log("收到连接请求");
                    connection = conn;
                    setupConnection();
                });
                
                peer.on('error', (err) => {
                    console.error('PeerJS错误:', err);
                    alert('连接错误: ' + err.message);
                });
            } catch (err) {
                console.error("PeerJS初始化错误:", err);
                alert("PeerJS初始化失败: " + err.message);
            }
        }
        
        // 设置连接
        function setupConnection() {
            connection.on('open', () => {
                console.log("连接已打开");
                
                if (role === 'controller') {
                    document.getElementById('connectionStatus').innerHTML = '<span>已连接</span>';
                    document.getElementById('connectionStatus').className = 'status connected';
                } else {
                    document.getElementById('displayConnectionStatus').innerHTML = '<span>已连接</span>';
                    document.getElementById('displayConnectionStatus').className = 'status connected';
                }
            });
            
            connection.on('data', (data) => {
                console.log("收到数据:", data);
                handleIncomingData(data);
            });
            
            connection.on('close', () => {
                console.log("连接已关闭");
                
                if (role === 'controller') {
                    document.getElementById('connectionStatus').innerHTML = '<span>连接已断开</span>';
                    document.getElementById('connectionStatus').className = 'status';
                } else {
                    document.getElementById('displayConnectionStatus').innerHTML = '<span>连接已断开</span>';
                    document.getElementById('displayConnectionStatus').className = 'status';
                }
                
                connection = null;
            });
        }
        
        // 处理收到的数据
        function handleIncomingData(data) {
            if (!data || typeof data !== 'object') return;
            
            if (role === 'display' && data.type === 'content') {
                document.getElementById('promptContent').textContent = data.content;
            }
        }
        
        // 控制端函数
        function connectToPeer() {
            const peerId = document.getElementById('peerId').value.trim();
            if (!peerId) {
                alert('请输入显示端ID');
                return;
            }
            
            try {
                console.log("尝试连接到:", peerId);
                connection = peer.connect(peerId, { reliable: true });
                setupConnection();
            } catch (err) {
                console.error('连接错误:', err);
                alert('连接失败: ' + err.message);
            }
        }
        
        function sendText() {
            if (!connection) {
                alert('请先连接到显示端');
                return;
            }
            
            const text = document.getElementById('promptText').value;
            console.log("发送文本:", text);
            connection.send({ type: 'content', content: text });
        }
        
        function clearText() {
            document.getElementById('promptText').value = '';
            if (connection) {
                connection.send({ type: 'content', content: '' });
            }
        }
        
        // 复制ID函数
        function copyMyId() {
            const myId = document.getElementById('myId');
            myId.select();
            document.execCommand('copy');
            alert('ID已复制到剪贴板');
        }
        
        function copyDisplayId() {
            const displayId = document.getElementById('displayId');
            displayId.select();
            document.execCommand('copy');
            alert('ID已复制到剪贴板');
        }
    </script>
</body>
</html>
